declare @almost_late_date datetime
declare @today datetime
declare @late_tasks int 
declare @almost_late_tasks int 
declare @tasks_for_today int 
declare @open_requests int 
declare @projects_in_progress int 
declare @total_projects int 
declare @total_actual_tasks int
declare @total_requests int
declare @late_tasks_percent int 
declare @open_requests_percent int 
declare @projects_in_progress_percent int 
declare @tasks_for_today_percent int

set @today = getdate()
set @almost_late_date = dateadd(day,+2,@today)

set @late_tasks = (select count(*) as late_tasks
from actual_tasks as at
where at.end_date < @today)

set @almost_late_tasks = (select count(*) as almost_late_tasks
from actual_tasks as at
where at.end_date > @today and at.end_date <= @almost_late_date)

set @tasks_for_today = (select count(*) as tasks_for_today
from actual_tasks as at
where at.end_date = @today)

set @open_requests = (
select count(*) as open_requests
from requests as r
join requests_statuses rs on rs.request_id = r.id
join  statuses s on s.id = rs.status_id
where s.title ='פתוחה'
)

set @projects_in_progress =(
select count(*) as projects_in_progress
from projects p 
join projects_statuses ps on p.id = ps.project_id
join statuses s on s.id = ps.status_id
where s.title != 'סגור'
)

set @total_projects = (select count(*) as total_projects  from projects)

set @total_actual_tasks =(select count(*) as total_actual_tasks from actual_tasks)

set @total_requests = (select count(*) as total_requests from requests)

set @open_requests_percent = (round((cast(@open_requests as float) / cast (@total_requests as float))*100,0))

set @late_tasks_percent = (round((cast(@late_tasks as float) / cast (@total_actual_tasks as float))*100,0))

set @projects_in_progress_percent = (round((cast(@projects_in_progress as float) / cast (@total_projects as float))*100,0))

set @tasks_for_today_percent = (round((cast(@tasks_for_today as float) / cast (@total_actual_tasks as float))*100,0))

select @late_tasks late_tasks, @projects_in_progress projects_in_progress, @tasks_for_today tasks_for_today, @open_requests open_requests, @projects_in_progress_percent projects_in_progress_percent, @late_tasks_percent late_tasks_percent, @tasks_for_today_percent tasks_for_today_percent , @open_requests_percent open_requests_percent